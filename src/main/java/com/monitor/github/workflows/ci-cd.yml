name: CI/CD Pipeline - Monitor App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Job de Build e Testes
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build com Maven
        run: mvn clean package -DskipTests

      - name: Executar testes
        run: mvn test

      - name: Upload artefato do build
        uses: actions/upload-artifact@v4
        with:
          name: monitor-app
          path: target/*.jar

  # Job de Deploy para Staging
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Baixar artefato do build
        uses: actions/download-artifact@v4
        with:
          name: monitor-app

      - name: Build da imagem Docker
        run: docker build -t monitor-app:staging .

      - name: Log de sucesso Staging
        run: echo "‚úÖ Deploy para STAGING conclu√≠do - Aplica√ß√£o pronta para testes"

  # Job de Deploy para Produ√ß√£o (manual)
  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Aprova√ß√£o manual para Produ√ß√£o
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ vars.APPROVERS || 'monitor-admin' }}
          minimum-approvals: 1
          issue-title: 'Aprova√ß√£o necess√°ria para deploy em Produ√ß√£o'
          issue-body: 'Por favor, aprove o deploy da aplica√ß√£o Monitor para produ√ß√£o.'

      - name: Log de sucesso Produ√ß√£o
        run: echo "üöÄ Deploy para PRODU√á√ÉO aprovado - Aplica√ß√£o em produ√ß√£o"